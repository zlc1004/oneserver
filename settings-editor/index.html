<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Settings Editor</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1000px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }

        h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }

        .btn-outline { background-color: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background-color: #f1f5f9; }

        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }

        .editor-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .field-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
        }

        input, select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.875rem;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            ring: 2px solid #bfdbfe;
        }

        .hidden { display: none !important; }

        #drop-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: var(--card-bg);
            cursor: pointer;
            margin-bottom: 20px;
        }

        #drop-zone.dragover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .entry-index {
            color: #94a3b8;
            font-size: 0.75rem;
            margin-right: 10px;
        }

        .checkbox-group {
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input {
            width: auto;
        }

        #raw-json-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        textarea#raw-json {
            flex-grow: 1;
            width: 100%;
            height: 400px;
            font-family: monospace;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 4px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>JSON Settings Editor</h1>
            <div class="actions">
                <button class="btn-outline" onclick="showRawJson()">View Raw</button>
                <button class="btn-outline" onclick="addNewEntry()">+ Add Entry</button>
                <button class="btn-primary" onclick="exportJSON()">Export JSON</button>
            </div>
        </header>

        <div id="drop-zone" onclick="document.getElementById('file-input').click()">
            <p>Drag & drop settings.json here or click to upload</p>
            <input type="file" id="file-input" class="hidden" accept=".json">
        </div>

        <div id="editor-container" class="editor-grid">
            <!-- Cards will be rendered here -->
        </div>
    </div>

    <div id="raw-json-modal" class="hidden">
        <div class="modal-content">
            <h2>Raw JSON</h2>
            <textarea id="raw-json"></textarea>
            <div class="actions" style="justify-content: flex-end;">
                <button class="btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="applyRawJson()">Apply Changes</button>
            </div>
        </div>
    </div>

    <script>
        let settingsData = [];

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const editorContainer = document.getElementById('editor-container');
        const modal = document.getElementById('raw-json-modal');
        const rawJsonTextarea = document.getElementById('raw-json');

        // File handling
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) readFile(file);
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) readFile(file);
        });

        function readFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    settingsData = Array.isArray(json) ? json : [json];
                    renderEditor();
                } catch (err) {
                    alert('Error parsing JSON: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function renderEditor() {
            editorContainer.innerHTML = '';
            settingsData.forEach((entry, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const header = document.createElement('div');
                header.className = 'card-header';
                header.innerHTML = `
                    <div class="card-title">
                        <span class="entry-index">#${index + 1}</span>
                        ${entry.domain || 'New Entry'}
                    </div>
                    <button class="btn-danger" onclick="deleteEntry(${index})">Delete</button>
                `;
                
                const fieldsContainer = document.createElement('div');
                fieldsContainer.className = 'field-group';
                
                // Define common fields to show prominently
                const commonFields = [
                    { key: 'domain', label: 'Domain', type: 'text' },
                    { key: 'forwarding', label: 'Forwarding', type: 'text' },
                    { key: 'type', label: 'Type', type: 'select', options: ['https', 'http'] },
                    { key: 'ca-bundle', label: 'CA Bundle', type: 'text' },
                    { key: 'private-key', label: 'Private Key', type: 'text' },
                    { key: 'websocket', label: 'Websocket', type: 'checkbox' },
                    { key: 'max-body-size', label: 'Max Body Size', type: 'text' },
                    { key: 'timeout', label: 'Timeout', type: 'text' }
                ];

                commonFields.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field';
                    if (field.type === 'checkbox') fieldDiv.classList.add('checkbox-group');

                    const label = document.createElement('label');
                    label.textContent = field.label;
                    
                    let input;
                    if (field.type === 'select') {
                        input = document.createElement('select');
                        field.options.forEach(opt => {
                            const o = document.createElement('option');
                            o.value = opt;
                            o.textContent = opt;
                            if (entry[field.key] === opt) o.selected = true;
                            input.appendChild(o);
                        });
                    } else {
                        input = document.createElement('input');
                        input.type = field.type;
                        if (field.type === 'checkbox') {
                            input.checked = !!entry[field.key];
                        } else {
                            input.value = entry[field.key] || '';
                        }
                    }

                    input.addEventListener('change', (e) => {
                        const val = field.type === 'checkbox' ? e.target.checked : e.target.value;
                        updateEntry(index, field.key, val);
                        if (field.key === 'domain') renderEditor(); // Update title
                    });

                    fieldDiv.appendChild(label);
                    fieldDiv.appendChild(input);
                    fieldsContainer.appendChild(fieldDiv);
                });

                // Handle extra fields (like allowed-paths or custom ones)
                const extraFields = Object.keys(entry).filter(k => !commonFields.find(f => f.key === k));
                extraFields.forEach(key => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field';
                    const label = document.createElement('label');
                    label.textContent = key + ' (JSON)';
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = typeof entry[key] === 'object' ? JSON.stringify(entry[key]) : entry[key];
                    
                    input.addEventListener('change', (e) => {
                        try {
                            const val = JSON.parse(e.target.value);
                            updateEntry(index, key, val);
                        } catch {
                            updateEntry(index, key, e.target.value);
                        }
                    });

                    fieldDiv.appendChild(label);
                    fieldDiv.appendChild(input);
                    fieldsContainer.appendChild(fieldDiv);
                });

                card.appendChild(header);
                card.appendChild(fieldsContainer);
                editorContainer.appendChild(card);
            });
        }

        function updateEntry(index, key, value) {
            settingsData[index][key] = value;
        }

        function addNewEntry() {
            settingsData.push({
                domain: "",
                forwarding: "host.docker.internal:",
                type: "https",
                websocket: true
            });
            renderEditor();
        }

        function deleteEntry(index) {
            if (confirm('Are you sure you want to delete this entry?')) {
                settingsData.splice(index, 1);
                renderEditor();
            }
        }

        function exportJSON() {
            const dataStr = JSON.stringify(settingsData, null, 4);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'settings.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function showRawJson() {
            rawJsonTextarea.value = JSON.stringify(settingsData, null, 4);
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function applyRawJson() {
            try {
                const json = JSON.parse(rawJsonTextarea.value);
                settingsData = Array.isArray(json) ? json : [json];
                renderEditor();
                closeModal();
            } catch (err) {
                alert('Invalid JSON: ' + err.message);
            }
        }
    </script>
</body>
</html>
